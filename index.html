<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My CMS Portfolio Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
    <h1>Patient Dashboard Prototype</h1>
    <div id="patient-name">Loading...</div>
    <hr>
    <h3>Vitals (Recent)</h3>
    <ul id="vitals-list"></ul>

    <script>
        // 1. Configuration
        const config = {
            clientId: "15fb9dc7-4441-406f-8e2c-967f37b80471", // Paste your Epic Client ID here
            scope: "openid fhirUser patient/Patient.read patient/Observation.read patient/Observation.search",
            iss: "https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/",
            redirectUri: window.location.origin + window.location.pathname
        };

        // 2. The Logic
        FHIR.oauth2.ready()
            .then(client => {
                // Fetch Patient Name
                client.request(`Patient/${client.patient.id}`)
                    .then(patient => {
                        const name = patient.name[0].given.join(" ") + " " + patient.name[0].family;
                        document.getElementById('patient-name').innerText = "Patient: " + name;
                    });

                // Fetch Vitals (Observations)
                client.request(`Observation?patient=${client.patient.id}&category=vital-signs,laboratory,social-history,core-characteristics`)
                    .then(data => {
                        const list = document.getElementById('vitals-list');
                        data.entry.forEach(item => {
                            const obs = item.resource;
                            if (!obs) return;
                        
                            const li = document.createElement('li');
                        
                            // 1. Get the Name (Epic often hides it in coding[0].display)
                            const name = obs.code?.text || 
                                         obs.code?.coding?.[0]?.display || 
                                         "Observation";
                        
                            // 2. Handle Complex Vitals (like Blood Pressure)
                            if (obs.component && obs.component.length > 0) {
                                const componentData = obs.component.map(comp => {
                                    const cName = comp.code?.text || comp.code?.coding?.[0]?.display || "";
                                    const cValue = comp.valueQuantity?.value ?? "N/A";
                                    const cUnit = comp.valueQuantity?.unit || "";
                                    return `${cName}: ${cValue}${cUnit}`;
                                }).join(" / ");
                                
                                li.innerHTML = `<strong>${name}</strong>: ${componentData}`;
                            } 
                            // 3. Handle Simple Vitals (Height, Weight, Temp)
                            else {
                                const value = obs.valueQuantity?.value ?? 
                                              obs.valueString ?? 
                                              obs.valueCodeableConcept?.text ?? 
                                              "No Data";
                                const unit = obs.valueQuantity?.unit || "";
                                
                             //   li.innerHTML = `<strong>${name}</strong>: ${value} ${unit}`;
                                // This checks the three most common places Epic hides the date
                                const rawDate = obs.effectiveDateTime || obs.issued || (obs.effectivePeriod && obs.effectivePeriod.start);
                                const dateLabel = rawDate ? new Date(rawDate).toLocaleDateString() : "No Date";
                                li.innerHTML = `<strong>[${dateLabel}] ${name}</strong>: ${displayValue} ${unit}`;
                             //   const date = obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleDateString() : "No Date";
                             //   li.innerHTML = `<strong>[${date}] ${name}</strong>: ${displayValue} ${unit}`;
                            }
                        
                            list.appendChild(li);
                        });

                    });
            })
            .catch(() => {
                // If not authorized, start the login flow
                FHIR.oauth2.authorize(config);
            });
    </script>

</body>
    
</html>
