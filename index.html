<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My CMS Portfolio Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <link rel="manifest" href="./manifest.webmanifest">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <canvas id="weightChart" width="400" height="200"></canvas>
    <h1>Patient Dashboard Prototype</h1>
    <div id="patient-name">Loading...</div>
    <hr>
    <h3>Vitals (Recent)</h3>
    <ul id="vitals-list"></ul>

    <script>
        // 1. Configuration
        const config = {
            clientId: "15fb9dc7-4441-406f-8e2c-967f37b80471", // Paste your Epic Client ID here
            scope: "openid fhirUser patient/Patient.read patient/Observation.read patient/Observation.search",
            iss: "https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/",
            redirectUri: window.location.origin + window.location.pathname
        };

        // 2. The Logic
        FHIR.oauth2.ready()
            .then(client => {
                // Fetch Patient Name
                client.request(`Patient/${client.patient.id}`)
                    .then(patient => {
                        const name = patient.name[0].given.join(" ") + " " + patient.name[0].family;
                        document.getElementById('patient-name').innerText = "Patient: " + name;
                    });

                // Fetch Vitals (Observations)
                client.request(`Observation?patient=${client.patient.id}&category=vital-signs,laboratory,social-history,core-characteristics`)
                    .then(data => {
                        const list = document.getElementById('vitals-list');
const weightLabels = [];
const weightValues = [];                        
data.entry.forEach(item => {
    const obs = item.resource;
    if (!obs) return;

    // 1. Initialize the variable UP HERE so it's defined for the whole loop
    let displayValue = "No Data"; 
    const name = obs.code?.text || obs.code?.coding?.[0]?.display || "Observation";
    const rawDate = obs.effectiveDateTime || obs.issued || (obs.effectivePeriod && obs.effectivePeriod.start);
    const dateLabel = rawDate ? new Date(rawDate).toLocaleDateString() : "No Date";

    let displayValue = "No Data";
    // 2. Now fill the variable based on the data type
    if (obs.component) {
        displayValue = obs.component.map(c => {
            const val = c.valueQuantity?.value || "N/A";
            return val;
        }).join("/");
    } else {
        // This checks numbers, text results, and coded results (Labs often use valueCodeableConcept)
        displayValue = obs.valueQuantity?.value || 
                       obs.valueString || 
                       obs.valueCodeableConcept?.text || 
                       "N/A";
    }

    const unit = obs.valueQuantity?.unit || "";

    if (name.toLowerCase().includes("weight")) {
        weightLabels.push(dateLabel); // The date
        weightValues.push(parseFloat(displayValue)); // The number
    }

    // 3. Now this line will work because displayValue is "in scope"
    const li = document.createElement('li');
    li.innerHTML = `<strong>[${dateLabel}] ${name}</strong>: ${displayValue} ${unit}`;
    list.appendChild(li);
});
drawChart(weightLabels.reverse(), weightValues.reverse());
                    });
            })
            .catch(() => {
                // If not authorized, start the login flow
                FHIR.oauth2.authorize(config);
            });

function drawChart(labels, values) {
    const ctx = document.getElementById('weightChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Weight Trend (kg/lbs)',
                data: values,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        }
    });
}        
    </script>

</body>
    
</html>
